name: CI
on:
  pull_request:
    paths:
      - .sbtopts
      - build.sbt
      - project/**
      - deps/**
      - utils/**
      - client/**
      - snapi-client/**
      - snapi-frontend/**
      - parsers/**
      - snapi-truffle/**
      - python-client/**
      - sql-client/**
      - .github/workflows/ci.yaml
  workflow_dispatch:

env:
  SBT_OPTS : -Dsbt.log.noformat=true -Xss2m -Xms1g
  GITHUB_TOKEN: ${{ secrets.READ_PACKAGES }}

jobs:
  code-checks:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: headers
        run: ./ci/check headerCheckAll
      - name: scala fmt
        run: ./ci/check scalafmtCheckAll
      - name: java fmt
        run: ./ci/check javafmtCheckAll
      - name: doc
        run: ./ci/check doc
  tests:
    strategy:
      fail-fast: false
      matrix:
        component:
          - snapiFrontend
          - snapiClient
          - sqlClient
          - pythonClient
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - uses: oNaiPs/secrets-to-env-action@v1.5
        with:
          secrets: ${{ toJSON(secrets) }}
      - run: env > .env
      - name: test
        run: ./ci/test ${{ matrix.component }}/test
      - uses: mikepenz/action-junit-report@v4
        if: success() || failure()
        with:
          annotate_only: true
          check_name: JUnit ${{ github.job }}  ${{ matrix.component }} report
          report_paths: ${{ env.REPORTS_DIR }}/*.xml
          detailed_summary: true
          require_tests: true
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: ${{ github.job }}-${{ github.run_number}}-${{ matrix.component }}-logs
          path: ${{ env.LOGS_DIR }}/${{ env.WD }}-logs
          retention-days: 7
          if-no-files-found: ignore
      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: ${{ github.job }}-${{ github.run_number}}-${{ matrix.component }}-heap-dumps
          path: ${{ env.LOGS_DIR }}/${{ env.WD }}-logs
          retention-days: 7
          if-no-files-found: ignore
