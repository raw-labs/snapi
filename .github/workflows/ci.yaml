name: CI
on:
  pull_request:
    paths:
      - deps/**
      - utils/**
      - client/**
      - snapi-frontend/**
      - snapi-truffle/**
      - snapi-client/**
      - .github/workflows/ci.yaml
  workflow_dispatch:

env:
  SBT_OPTS : -Dsbt.log.noformat=true -Xss2m -Xms1g

jobs:
  code-checks:
    strategy:
      matrix:
        component:
          - utils
          - client
          - snapi-frontend
          - snapi-truffle
          - snapi-client
    runs-on: self-hosted
    container:
      image: ghcr.io/raw-labs/raw-scala-runner:21.0.0-ol9-20230919_scala2.12.18_sbt1.6.2
      options: --user 1001
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.READ_PACKAGES }}
    steps:
      - uses: actions/checkout@v3
      - name: headers
        run: sbt headerCheckAll
        working-directory: ${{ matrix.component}}
      - name: scala fmt
        run: sbt scalafmtCheckAll
        working-directory: ${{ matrix.component}}
      - name: java fmt
        run: sbt javafmtCheckAll
        working-directory: ${{ matrix.component}}


  tests:
    needs: code-checks
    runs-on: self-hosted
    env:
      SBT_FORK_OUTPUT_DIR : test-results
      COURSIER_PROGRESS : false
    container:
      image: ghcr.io/raw-labs/raw-scala-runner:21.0.0-ol9-20230919_scala2.12.18_sbt1.6.2
      options: --user 1001 --cpus 6 --memory 32g -e HOME=/home/sbtuser
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.READ_PACKAGES }}
    steps:
      - uses: actions/checkout@v3
      - uses: oNaiPs/secrets-to-env-action@v1
        with:
          secrets: ${{ toJSON(secrets) }}
      - name: build deps
        run: |
          deps/kiama/build.sh
          deps/scala-logging/build.sh
      - name: build utils
        run: ./build.sh
        working-directory: utils
      - name: build client
        run: ./build.sh
        working-directory: client
      - name: build snapi-frontend
        run: ./build.sh
        working-directory: snapi-frontend
      - name: build snapi-truffle
        run: ./build.sh
        working-directory: snapi-truffle
      - name: build snapi-client
        run: ./build.sh
        working-directory: snapi-client
      - name: utils doc
        run: sbt doc
        working-directory: utils
      - name: client doc
        working-directory: client
        run: sbt doc
      - name: snapi-frontend doc
        working-directory: snapi-frontend
        run: sbt doc
      - name: snapi-truffle doc
        working-directory: snapi-truffle
        run: sbt doc
      - name: snapi-client doc
        working-directory: snapi-client
        run: sbt doc
      - run: ./tests.sh
      - uses: mikepenz/action-junit-report@v3
        if: success() || failure()
        with:
          report_paths: ./**/test-reports/*.xml
          detailed_summary: true
      - uses: actions/upload-artifact@v3
        with:
          name: executor-logs
          path: test-results/executor-logs
          retention-days: 7
          if-no-files-found: ignore
      - uses: actions/upload-artifact@v3
        with:
          name: heap-dumps
          path: test-results/heap-dumps
          retention-days: 7
          if-no-files-found: ignore
